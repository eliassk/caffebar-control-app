# Coffee Bar Control Panel

A tablet-first PWA for controlling Coffee Bar devices via Home Assistant, with a secure proxy backend that restricts access to an allowlisted set of entities and services.

## Structure

- **`frontend/`** — SvelteKit PWA (SPA), Tailwind, tablet-first UI
- **`backend/`** — Coffee API (Express + TypeScript), proxy to Home Assistant with allowlisting
- **`config/allowlist.json`** — Allowed entity IDs and service calls

## Quick start

### 1. Backend (Coffee API)

```bash
cd backend
cp .env.example .env
# Edit .env: set HA_BASE_URL, HA_TOKEN, ALLOWED_ORIGINS (e.g. http://localhost:5173)
npm install
npm run dev
```

Runs at `http://localhost:3001` by default. Health: `GET /health`.

**Run without Home Assistant (demo mode):** If you omit `HA_BASE_URL` and `HA_TOKEN` (or set `DEMO_MODE=true`), the backend uses **mock entities** (lights, HVAC, sensors, motion, switches) so you can develop and test the full UI. Toggles and “All off” update in-memory state only. The UI shows a **“Demo”** badge in the header when the API is in demo mode.  
**If you only see 4 entities (e.g. Coffee Machine, Grinder, Socket 1, Socket 2):** the backend is using real Home Assistant and your HA only has those entities. To see all card types (lights, climate, temperature graph, etc.), enable demo mode: in `backend/.env` set `DEMO_MODE=true` (or comment out `HA_BASE_URL` and `HA_TOKEN`), then restart the backend.

### 2. Frontend (PWA)

```bash
cd frontend
cp .env.example .env
# Edit .env: set VITE_API_BASE_URL=http://localhost:3001
npm install
npm run dev
```

Open `http://localhost:5173`. Install as PWA for kiosk/fullscreen.

### 3. Allowlist

Edit `config/allowlist.json`:

- **entities.exact** — exact `entity_id` values
- **entities.patterns** — globs like `switch.coffee_*`, `light.coffee_*`
- **services** — allowed `domain` / `service` pairs (e.g. `switch.turn_on`, `light.toggle`)

Only entities and services in this file are exposed to the UI.

## Backend API

- `GET /health` — Health check
- `GET /api/coffee/entities` — All allowed entities (state, attributes, friendly_name, icon, domain)
- `GET /api/coffee/entities/:entity_id` — Single entity
- `POST /api/coffee/service` — Body: `{ domain, service, entity_id?, data? }`
- `POST /api/coffee/toggle` — Body: `{ entity_id }` (switch/light)
- `POST /api/coffee/scene/open` — Runs `script.coffee_bar_open` if allowlisted
- `POST /api/coffee/scene/close` — Runs `script.coffee_bar_close` if allowlisted

Security: CORS locked to `ALLOWED_ORIGINS` (comma-separated), rate limiting (e.g. 120 req/min per IP), no HA token on frontend.

## Home Assistant

- Create a **Long-Lived Access Token** (Profile → Security → Create token).
- Set `HA_BASE_URL` (e.g. `http://homeassistant.local:8123`) and `HA_TOKEN` in backend `.env`.
- Ensure entities and scripts in the allowlist exist in HA.

## Kiosk

- Run the PWA in Chrome (or Android) and use “Install” for fullscreen.
- For a dedicated kiosk, use Chrome’s kiosk mode or an Android kiosk app pointing at the PWA URL.

## Clearing caches and rebuilding

If you change **demo data** (`backend/src/demo.ts`), **allowlist** (`config/allowlist.json`), or the frontend and still see old entities or old UI:

1. **Backend** — The allowlist and demo entities are loaded at startup. **Restart the backend** after changing `config/allowlist.json` or `backend/src/demo.ts`:
   ```bash
   cd backend && npm run dev
   ```
   (Stop with Ctrl+C, then start again.)

2. **Frontend build** — Clean and rebuild so the PWA and service worker are updated:
   ```bash
   cd frontend
   npm run rebuild
   ```
   If you see a tsconfig warning about `./.svelte-kit/tsconfig.json` not found, it’s because that file is generated by SvelteKit. Run `npm run build` or `npm run dev` once (e.g. after `npm run clean`) to recreate `.svelte-kit`.

3. **Browser / PWA cache** — The app is a PWA and caches API responses briefly. To see fresh entities immediately:
   - **Chrome (desktop):** DevTools → Application → Storage → “Clear site data”, or Application → Service Workers → “Unregister”.
   - **Chrome (Android):** Settings → Apps → Coffee Bar → Storage → Clear cache (or uninstall and re-open the PWA URL).
   - Hard refresh: Ctrl+Shift+R (Windows/Linux) or Cmd+Shift+R (Mac).

After a clean rebuild and backend restart, reload the app (and clear site data once if needed); you should then see the current entities.

## Production Deployment (Ubuntu VM)

For deployment on an Ubuntu VM (same LAN as Home Assistant, not exposed to the public internet):

**Prerequisites:** Node 18+ (install via [NodeSource](https://github.com/nodesource/distributions) if needed), VM on same LAN as Home Assistant

### Install script (recommended)

```bash
# Clone to install path
sudo git clone <repo-url> /opt/coffeebar
cd /opt/coffeebar

# Run install (creates user, builds, configures systemd)
sudo ./deploy/install.sh

# Or with options:
# sudo ./deploy/install.sh --port 3002 --dir /opt/coffeebar --no-start
```

The script will:
- Check for Node.js 18+
- Install deps and build
- Create config files from examples if missing
- Create `backend/.env` from example if missing
- Create `coffeebar` system user
- Install and enable systemd service

**After install:** Edit `backend/.env` (HA_BASE_URL, HA_TOKEN, ALLOWED_ORIGINS) and `config/*.json` for your entities. Restart: `sudo systemctl restart coffeebar`.

**500 errors loading JS assets?** Ensure `ALLOWED_ORIGINS` includes your access URL (e.g. `http://10.134.10.60:3001`), or set `ALLOW_LOCAL_ORIGINS=true` to allow any origin on your port.

### Manual install

1. Clone the repo (e.g. `/opt/coffeebar`)
2. `npm install && npm run build`
3. Copy config: `cp config/*.json.example config/` and rename to `.json`, or create from examples
4. `cp backend/.env.example backend/.env` and edit
5. Use `deploy/coffeebar.service` as template; adjust paths and run `systemctl enable --now coffeebar`

### Multi-service VM

- **Port:** Use `--port 3002` or set `PORT=3002` in `backend/.env` if 3001 is in use
- **Reverse proxy:** See `deploy/nginx-coffeebar.conf.example` for nginx config (subdomain or path)

**Verify:** `curl http://<vm-ip>:3001/health` should return `{"ok":true,...}`.

## Optional later

- WebSocket/SSE for realtime state (backend subscribes to HA, pushes to frontend)
- PIN screen for “All Off”
- Action logging (who/when)
- Theme/branding customization
